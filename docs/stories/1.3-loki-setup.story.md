# Story 1.3: Loki Setup

## Status
Draft

## Story
**As a** LLM Server Maintainer,  
**I want** to configure Loki for centralized log aggregation with 30-day retention,  
**so that** I can search and analyze logs from all containers through Grafana

## Acceptance Criteria
1. Deploy Loki container with proper configuration
2. Configure loki-config.yml with retention and storage settings
3. Set up Loki data source in Grafana
4. Configure 30-day log retention policy
5. Test Loki API access on port 23002

## Tasks / Subtasks
- [ ] Task 1: Deploy Loki container (AC: 1)
  - [ ] Update docker-compose.yml with Loki service definition
  - [ ] Configure Loki image version (v2.x) and port mapping (23002)
  - [ ] Set up persistent volume for Loki data storage
  - [ ] Configure container health check endpoint
- [ ] Task 2: Create Loki configuration file (AC: 2)
  - [ ] Create config/loki/loki-config.yml file
  - [ ] Configure storage settings (filesystem with docker volume)
  - [ ] Set up schema configuration for log storage
  - [ ] Configure ingester settings and chunk storage
  - [ ] Set up compactor for retention management
- [ ] Task 3: Configure retention policy (AC: 4)
  - [ ] Set retention period to 30 days (744h)
  - [ ] Configure deletion settings in compactor
  - [ ] Set up retention enforcement schedule
  - [ ] Configure storage limits if needed
- [ ] Task 4: Integrate Loki with Grafana (AC: 3)
  - [ ] Add Loki as data source in Grafana provisioning
  - [ ] Configure Grafana datasource URL (http://loki:3100)
  - [ ] Test connection from Grafana to Loki
  - [ ] Verify log queries work in Grafana Explore
- [ ] Task 5: Verify Loki deployment (AC: 5)
  - [ ] Start Loki container using docker-compose
  - [ ] Verify container is running and healthy
  - [ ] Test Loki API at http://localhost:23002/ready
  - [ ] Check metrics endpoint at http://localhost:23002/metrics
  - [ ] Verify storage volume is properly mounted
- [ ] Task 6: Add integration tests (AC: 2, 5)
  - [ ] Create test to validate loki-config.yml syntax
  - [ ] Test Loki readiness endpoint
  - [ ] Test log ingestion capabilities (prepare for Promtail)
  - [ ] Verify retention configuration is applied

## Dev Notes

### Previous Story Insights
From Story 1.2 completion:
- Prometheus successfully deployed on port 23001 with 30-day retention
- Docker Compose volume mount paths use ../config pattern (important for Loki config)
- Container health checks implemented using /health endpoints
- Integration test pattern established in tests/integration/

### Data Models
No specific data models required for Loki setup. Loki will store logs with labels and timestamps following its internal schema.

### API Specifications
Loki exposes the following endpoints [Source: architecture/external-apis.md]:
- Ready endpoint: `/ready` for health checks
- Metrics endpoint: `/metrics` for Prometheus scraping
- Push API: `/loki/api/v1/push` (for Promtail to use later)
- Query API: `/loki/api/v1/query_range` (for Grafana to use)

### Component Specifications
Loki Server Component [Source: architecture/components.md#loki-server]:
- **Image**: grafana/loki:2.x (use latest v2 release)
- **Port**: 23002 (external) â†’ 3100 (internal)
- **Purpose**: Log aggregation and storage with 30-day retention
- **Configuration**: Via loki-config.yml file mounted as volume
- **Technology Stack**: Loki 2.x with 30-day log retention

### File Locations
Based on unified project structure [Source: architecture/unified-project-structure.md]:
- Loki config: `config/loki/loki-config.yml`
- Docker service update: `docker/docker-compose.yml`
- Grafana datasource: `config/grafana/provisioning/datasources/datasources.yml`
- Volume mount: `loki-data` Docker volume
- Integration tests: `tests/integration/test_loki_setup.py`

### Testing Requirements
From testing strategy [Source: architecture/testing-strategy.md]:
- Integration test location: `tests/integration/test_loki_setup.py`
- Test that Loki starts and responds to health checks
- Validate configuration file syntax before deployment
- Test log ingestion readiness (for future Promtail integration)
- Manual verification of Grafana integration

### Technical Constraints
- **Loki Version**: 2.x (latest stable) [Source: architecture/tech-stack.md#technology-stack-table]
- **Log Retention**: 30 days (744 hours) [Source: architecture/high-level-architecture.md#technical-summary]
- **Port Assignment**: 23002 for external access [Source: prd.md#core-components]
- **Network**: Internal only, no external access [Source: architecture/coding-standards.md#critical-monitoring-system-rules]
- **Container Health**: Must expose /ready endpoint [Source: architecture/coding-standards.md#critical-monitoring-system-rules]
- **Storage**: Filesystem storage with Docker volume for persistence
- **Integration**: Must work with Grafana on internal network

### Project Structure Notes
- The `config/loki/` directory should already exist from story 1.1 implementation
- Follow the same volume mount pattern as Prometheus (../config path adjustment)
- Grafana provisioning directory structure exists for datasource configuration

## Testing
### Testing Standards
[Source: architecture/testing-strategy.md]:
- Test file location: `tests/integration/test_loki_setup.py`
- Test standards: pytest 8.x for Python testing
- Testing frameworks: Integration tests for service connectivity
- Specific requirements for this story:
  - Validate loki-config.yml syntax
  - Test Loki can start and respond to health checks
  - Verify retention configuration is applied
  - Test Grafana can connect to Loki
  - Manual verification of log query functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)